{% extends 'base.html' %}

{% block content %}


    <h1>{{ task.name }}</h1>
    <p>{{ task.description }}</p>

    <h2>Comments</h2>
    {% for comment in comments %}
        <div>
            <p>{{ comment.user.username }}: {{ comment.content }}</p>
            {% for image in comment.images.all %}
                <a href="{{ image.image.url }}" target="_blank">
                    <img src="{{ image.image.url }}" alt="{{ image.description }}"
                         style="max-width: 100px; max-height: 100px;">
                </a>
            {% endfor %}
        </div>
    {% endfor %}

    <h3>Add a comment</h3>
    <form id="comment-form" method="post" enctype="multipart/form-data" class="dropzone">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <div id="dropzone" style="width: 200px; height: 200px; border: 1px solid black;">
            Drop files here
        </div>
        <button type="submit">Add Comment</button>
    </form>
    <div id="preview"></div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var dropzone = document.getElementById('dropzone');
        var preview = document.getElementById('preview');
        var form = document.getElementById('comment-form');
        var files = [];

        dropzone.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        dropzone.addEventListener('drop', function (e) {
            e.preventDefault();

            files = e.dataTransfer.files;

            // Clear the preview div
            while (preview.firstChild) {
                preview.removeChild(preview.firstChild);
            }

            // Create a new image element for each file
            for (var i = 0; i < files.length; i++) {
                var img = document.createElement('img');
                img.src = URL.createObjectURL(files[i]);
                img.height = 100;
                img.onload = function () {
                    URL.revokeObjectURL(this.src);
                }
                preview.appendChild(img);
            }
        });

        form.addEventListener('submit', function (e) {
            var formData = new FormData(form);
            for (var i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }

            e.preventDefault();
            fetch('{% url "task_detail" task_id=task.id %}', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    console.log('Upload successful');
                } else {
                    console.error('Upload failed');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
        });
    });
</script>

{% endblock %}